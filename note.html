<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Studio d'Ã©criture â€” Notes riches</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&family=Merriweather&family=JetBrains+Mono&family=Atkinson+Hyperlegible&display=swap" rel="stylesheet">
    
    <style>
        /* reset complet vers le blanc */
        * {
            background-color: white;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html, main, div, header, footer, section, article {
            background: white !important;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: #1e293b;
            min-height: 100vh;
        }
        /* accessibilitÃ© tactile mobile */
        @media (max-width: 640px) {
            button, .p-2, .rounded-full {
                min-height: 48px;
                min-width: 48px;
            }
            .text-4xl { font-size: 2rem; }
        }
        /* zone d'Ã©dition extensible */
        .editable-area {
            width: 100%;
            min-height: 60vh;
            background: white;
            border: none;
            resize: vertical;
            font-size: 1.2rem;
            line-height: 1.7;
            color: #0f172a;
            caret-color: #4f46e5;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0.5rem 0;
        }
        .editable-area:empty:before {
            content: attr(placeholder);
            color: #cbd5e1;
            font-style: normal;
            font-weight: 300;
        }
        /* toolbar flottante Ã©purÃ©e */
        .toolbar-glass {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(8px);
            border: 1px solid #f1f5f9;
            border-radius: 48px;
            padding: 0.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .toolbar-btn {
            padding: 0.6rem 1rem;
            border-radius: 40px;
            transition: all 0.1s;
            font-weight: 500;
            background: transparent;
            white-space: nowrap;
        }
        .toolbar-btn:hover {
            background: #f8fafc;
        }
        .highlight-yellow { background-color: #fef9c3; color: #1e293b; }
        .highlight-green { background-color: #dcfce7; color: #14532d; }
        .highlight-blue { background-color: #dbeafe; color: #1e3a8a; }
        .highlight-remove { background-color: transparent; }
        /* toast */
        #toast {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <!-- HEADER minimal -->
    <header class="sticky top-0 z-40 bg-white border-b border-slate-100">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="p-2 text-slate-400 hover:text-indigo-600 rounded-full hover:bg-slate-50 transition-all" title="Retour">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <span id="noteDate" class="text-sm text-slate-400 font-light">Brouillon</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="deleteNote()" id="deleteBtn" class="hidden p-2 text-rose-400 hover:text-rose-600 rounded-full hover:bg-rose-50 transition-colors" title="Supprimer">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
                <button onclick="saveNote()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-full text-sm font-medium shadow-sm flex items-center gap-2 active:scale-95 transition">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Sauvegarder</span>
                </button>
            </div>
        </div>
    </header>

    <!-- BARRE D'OUTILS avec 3 surligneurs + annuler/rÃ©tablir -->
    <div class="sticky top-16 z-30 py-2 bg-white/95 backdrop-blur-sm border-b border-slate-100">
        <div class="max-w-4xl mx-auto px-4">
            <div class="toolbar-glass flex flex-wrap items-center gap-1 justify-center sm:justify-start">
                <!-- gras -->
                <button onclick="applyFormat('bold')" class="toolbar-btn" title="Gras (Ctrl+B)"><i data-lucide="bold" class="w-4 h-4"></i></button>
                
                <!-- 3 surligneurs + neutre -->
                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                <button onclick="applyHighlight('#fef9c3')" class="toolbar-btn" style="background:#fef9c3; color:#92400e;" title="Surligner jaune">ðŸŸ¨</button>
                <button onclick="applyHighlight('#dcfce7')" class="toolbar-btn" style="background:#dcfce7; color:#166534;" title="Surligner vert">ðŸŸ©</button>
                <button onclick="applyHighlight('#dbeafe')" class="toolbar-btn" style="background:#dbeafe; color:#1e40af;" title="Surligner bleu">ðŸŸ¦</button>
                <button onclick="removeHighlight()" class="toolbar-btn" title="Enlever le surlignage"><i data-lucide="eraser" class="w-4 h-4"></i></button>
                
                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                <!-- taille de police -->
                <button onclick="changeFontSize(0.1)" class="toolbar-btn" title="Agrandir"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button onclick="changeFontSize(-0.1)" class="toolbar-btn" title="RÃ©duire"><i data-lucide="minus" class="w-4 h-4"></i></button>
                
                <!-- police -->
                <select id="fontSelect" onchange="changeFont(this.value)" class="toolbar-btn bg-transparent border-0 focus:ring-0 text-sm">
                    <option value="Inter">Inter</option>
                    <option value="Merriweather">Merriweather</option>
                    <option value="Atkinson Hyperlegible">Atkinson</option>
                    <option value="JetBrains Mono">Mono</option>
                </select>
                
                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                <!-- annuler / rÃ©tablir -->
                <button onclick="undoAction()" class="toolbar-btn" title="Annuler (Ctrl+Z)"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
                <button onclick="redoAction()" class="toolbar-btn" title="RÃ©tablir (Ctrl+Y)"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- ZONE PRINCIPALE D'Ã‰DITION -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- Titre -->
        <input type="text" id="titleInput" placeholder="Titre (facultatif)" 
            class="w-full text-4xl sm:text-5xl font-light text-slate-800 placeholder-slate-200 border-none focus:outline-none focus:ring-0 bg-transparent px-0 py-2">
        
        <div class="h-px bg-slate-100 my-4"></div>
        
        <!-- Ã‰diteur riche contenteditable -->
        <div id="editor" 
            class="editable-area" 
            placeholder="Commencez Ã  Ã©crire ici... (sÃ©lectionnez du texte pour le personnaliser)"
            contenteditable="true">
        </div>
        
        <!-- infos bas de page -->
        <div class="mt-6 flex justify-between items-center text-xs text-slate-300">
            <span id="charCount">0 caractÃ¨res</span>
            <span class="flex gap-3">
                <span id="saveStatus"></span>
                <span>âŒ˜+S sauvegarde</span>
            </span>
        </div>
    </main>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-4 rounded-2xl shadow-xl border border-slate-200 transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50 bg-white">
        <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5 text-emerald-500"></i>
        <span id="toastMessage" class="font-medium text-slate-700">PrÃªt</span>
    </div>

    <script>
        (function() {
            // ----- FIREBASE -----
            const firebaseConfig = {
                apiKey: "AIzaSyDfJwZNAtT5u9sKdw7R2J7QOcohf2_03Vk",
                authDomain: "souhaibou-4883d.firebaseapp.com",
                projectId: "souhaibou-4883d",
                storageBucket: "souhaibou-4883d.firebasestorage.app",
                messagingSenderId: "703566382245",
                appId: "1:703566382245:web:82e265798635786bb8794c",
                measurementId: "G-SW6XGD9YHY"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            // ----- Ã‰LÃ‰MENTS DOM -----
            const editor = document.getElementById('editor');
            const titleInput = document.getElementById('titleInput');
            const noteDateSpan = document.getElementById('noteDate');
            const deleteBtn = document.getElementById('deleteBtn');
            const charCountSpan = document.getElementById('charCount');
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            const fontSelect = document.getElementById('fontSelect');
            const saveStatus = document.getElementById('saveStatus');
            
            // ----- Ã‰TAT GLOBAL -----
            let noteId = new URLSearchParams(window.location.search).get('id');
            let isDirty = false;
            let currentFontSize = 1.2; // rem
            
            // Initialisation Lucide
            lucide.createIcons();

            // --- CHARGEMENT NOTE ---
            if (noteId) {
                loadNote(noteId);
                deleteBtn.classList.remove('hidden');
            } else {
                noteDateSpan.textContent = 'Nouvelle note';
                editor.focus();
            }

            // --- COMPTEUR & DIRTY ---
            function updateCharCount() {
                const text = editor.innerText || '';
                charCountSpan.textContent = `${text.length} caractÃ¨re${text.length !== 1 ? 's' : ''}`;
                isDirty = true;
            }
            editor.addEventListener('input', updateCharCount);
            titleInput.addEventListener('input', () => { isDirty = true; });

            // --- SAUVEGARDE (corrigÃ©e avec vÃ©rification toast) ---
            async function saveNote() {
                const title = titleInput.value.trim() || 'Sans titre';
                const contentHtml = editor.innerHTML.trim();
                const contentText = editor.innerText.trim();
                
                if (!contentText && !titleInput.value.trim()) {
                    showToast('Ã‰crivez quelque chose', 'error');
                    return;
                }
                
                const now = new Date().toISOString();
                const noteData = {
                    title,
                    content: contentText,
                    contentHtml: contentHtml || '',
                    fontFamily: editor.style.fontFamily || 'Inter',
                    fontSize: currentFontSize.toString(),
                    updatedAt: now
                };
                
                try {
                    if (noteId) {
                        await db.collection('notes').doc(noteId).update(noteData);
                        showToast('Note mise Ã  jour', 'success');
                    } else {
                        const newId = Date.now().toString(36) + '-' + Math.random().toString(36).substring(2);
                        noteId = newId;
                        await db.collection('notes').doc(newId).set({
                            ...noteData,
                            id: newId,
                            createdAt: now
                        });
                        window.history.replaceState({}, '', `?id=${newId}`);
                        deleteBtn.classList.remove('hidden');
                        showToast('Nouvelle note enregistrÃ©e', 'success');
                    }
                    isDirty = false;
                    noteDateSpan.textContent = `enreg. ${formatDate(now)}`;
                    if (saveStatus) saveStatus.textContent = 'âœ” sauvegardÃ©';
                    setTimeout(() => { if (saveStatus) saveStatus.textContent = ''; }, 2000);
                } catch (e) {
                    console.error('save error', e);
                    showToast('Erreur de sauvegarde', 'error');
                }
            }

            // --- CHARGEMENT ---
            async function loadNote(id) {
                try {
                    const doc = await db.collection('notes').doc(id).get();
                    if (doc.exists) {
                        const note = doc.data();
                        titleInput.value = note.title || '';
                        editor.innerHTML = note.contentHtml || note.content || '';
                        if (note.fontFamily) {
                            editor.style.fontFamily = note.fontFamily;
                            fontSelect.value = note.fontFamily;
                        }
                        if (note.fontSize) {
                            currentFontSize = parseFloat(note.fontSize) || 1.2;
                            editor.style.fontSize = currentFontSize + 'rem';
                        }
                        noteDateSpan.textContent = note.updatedAt ? `modif. ${formatDate(note.updatedAt)}` : 'note';
                        updateCharCount();
                        lucide.createIcons();
                    } else {
                        showToast('Note introuvable', 'error');
                        setTimeout(() => window.location.href = 'index.html', 1500);
                    }
                } catch (e) {
                    showToast('Erreur chargement', 'error');
                }
            }

            // --- SUPPRESSION ---
            async function deleteNote() {
                if (!noteId || !confirm('Supprimer dÃ©finitivement ?')) return;
                try {
                    await db.collection('notes').doc(noteId).delete();
                    showToast('Note supprimÃ©e', 'success');
                    setTimeout(() => window.location.href = 'index.html', 1000);
                } catch (e) {
                    showToast('Erreur suppression', 'error');
                }
            }

            // --- FORMATAGE : GRAS ---
            function applyFormat(command) {
                document.execCommand('styleWithCSS', false, true);
                if (command === 'bold') document.execCommand('bold', false, null);
                editor.focus();
                updateCharCount();
                lucide.createIcons();
            }

            // --- SURLIGNEUR avec 3 couleurs + effacer ---
            function applyHighlight(color) {
                document.execCommand('styleWithCSS', false, true);
                // appliquer la couleur de fond
                document.execCommand('backColor', false, color);
                editor.focus();
                updateCharCount();
                lucide.createIcons();
            }
            function removeHighlight() {
                document.execCommand('styleWithCSS', false, true);
                // mettre fond transparent
                document.execCommand('backColor', false, 'transparent');
                editor.focus();
                updateCharCount();
                lucide.createIcons();
            }

            // --- TAILLE POLICE ---
            function changeFontSize(delta) {
                currentFontSize = Math.min(2.8, Math.max(0.9, currentFontSize + delta));
                editor.style.fontSize = currentFontSize + 'rem';
                isDirty = true;
                editor.focus();
            }

            // --- CHANGER POLICE ---
            function changeFont(font) {
                editor.style.fontFamily = `'${font}', sans-serif`;
                isDirty = true;
                editor.focus();
            }

            // --- ANNULER / RÃ‰TABLIR (undo/redo natif) ---
            function undoAction() {
                document.execCommand('undo', false, null);
                editor.focus();
                updateCharCount();
            }
            function redoAction() {
                document.execCommand('redo', false, null);
                editor.focus();
                updateCharCount();
            }

            // --- TOAST (correction bug null setAttribute) ---
            function showToast(msg, type = 'success') {
                if (!toast || !toastIcon || !toastMessage) return;
                
                toastMessage.textContent = msg;
                
                // Mise Ã  jour sÃ©curisÃ©e de l'icÃ´ne
                const iconName = type === 'error' ? 'alert-circle' : 'check-circle';
                const colorClass = type === 'error' ? 'text-rose-500' : 'text-emerald-500';
                
                // Remplacer l'icÃ´ne via dataset (plus fiable que setAttribute sur l'Ã©lÃ©ment)
                toastIcon.setAttribute('data-lucide', iconName);
                toastIcon.className = `w-5 h-5 ${colorClass}`;
                
                lucide.createIcons(); // rÃ©initialise toutes les icÃ´nes
                
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 2700);
            }

            // --- FORMAT DATE ---
            function formatDate(iso) {
                if (!iso) return '';
                const d = new Date(iso);
                return d.toLocaleDateString('fr-FR', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
            }

            // --- AUTO-SAVE ---
            setInterval(() => { if (isDirty) saveNote(); }, 30000);

            // --- RACCOURCIS CLAVIER ---
            editor.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveNote();
                }
                // laisser Ctrl Z / Y natifs fonctionner
            });

            // --- EXPOSITION GLOBALE (pour les attributs onclick) ---
            window.saveNote = saveNote;
            window.deleteNote = deleteNote;
            window.applyFormat = applyFormat;
            window.applyHighlight = applyHighlight;
            window.removeHighlight = removeHighlight;
            window.changeFontSize = changeFontSize;
            window.changeFont = changeFont;
            window.undoAction = undoAction;
            window.redoAction = redoAction;

            // initialisation compteur
            updateCharCount();
            lucide.createIcons();

            // prÃ©venir perte donnÃ©es
            window.addEventListener('beforeunload', (e) => { if (isDirty) { e.preventDefault(); e.returnValue = ''; } });
        })();
    </script>
    
    <!-- petits ajustements -->
    <style>
        /* garder le fond blanc */
        [contenteditable] {
            background: white;
        }
        .toolbar-glass button, .toolbar-glass select {
            background: transparent;
        }
        /* couleurs de surlignage spÃ©cifiques */
        mark, [style*="background-color"] {
            border-radius: 0.2em;
            padding: 0 0.1em;
        }
    </style>
</body>
</html>
